// Prisma schema for Airtable Import Application - DUAL SCHEMA SYSTEM
// Uses 'app' schema for application management and 'data' schema for imported data
// Both schemas exist in the same DigitalOcean PostgreSQL database

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL") // DigitalOcean database with app and data schemas
  schemas  = ["app", "data"]
}

// User management - stored in 'app' schema
model User {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  password  String
  role      UserRole @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  importSessions ImportSession[]

  @@map("users")
  @@schema("app")
}

//User authentication and configuration database models

// User role enumeration for permission management
enum UserRole {
  USER      // Regular user with basic import permissions
  ADMIN     // Admin user with settings management  
  SUPERADMIN // Superadmin with all system permissions
  
  @@schema("app")
}

// Settings removed - Airtable configuration moved to environment variables

// Import session tracking - stored in 'app' schema
model ImportSession {
  id          String            @id @default(cuid())
  userId      Int
  status      ImportStatus      @default(PENDING)
  startTime   DateTime          @default(now())
  endTime     DateTime?
  tableNames  String[]         // Array of table names being imported
  totalTables Int              @default(0)
  totalRecords Int             @default(0)
  processedRecords Int         @default(0)
  results     Json?            // Per-table results with processedRecords and skippedRecords
  errorMessage String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  importedTables ImportedTable[]

  @@map("import_sessions")
  @@schema("app")
}

// Track imported tables metadata - stored in 'app' schema
model ImportedTable {
  id              Int      @id @default(autoincrement())
  sessionId       String
  tableName       String
  airtableTableId String?
  recordCount     Int      @default(0)
  status          ImportStatus @default(PENDING)
  errorMessage    String?
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  session ImportSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, tableName])
  @@map("imported_tables")
  @@schema("app")
}

// Dynamic schema tracking for imported Airtable tables - stored in 'app' schema
model AirtableSchema {
  id          Int      @id @default(autoincrement())
  tableName   String   @unique
  baseId      String
  airtableId  String
  fields      Json     // Store field definitions as JSON
  lastSync    DateTime @default(now())
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("airtable_schemas")
  @@schema("app")
}

// Enum definitions
enum ImportStatus {
  PENDING
  RUNNING
  COMPLETED
  FAILED
  PARTIAL_FAILED
  CANCELLED
  
  @@schema("app")
}


